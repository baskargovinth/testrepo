<!-- $Id: index.html baskar.govindan Exp$-->
<html>
	<head>
		<meta charset="utf-8">
		
		<link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/2/zendesk_garden.css" type="text/css">
		<link rel="stylesheet" href="../../styles/ADManagerStyle.css" type="text/css">
		
		<script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
		<script type="text/javascript" src="../../js/ADManagerErrorHandler.js"></script>
		<script type="text/javascript" src="../../js/ADManagerCommonUtil.js"></script>
		<script type="text/javascript" src="../../js/ADManagerConfiguration.js"></script>
		
	</head>
	<body>
			<div id="statusDiv">
				<div class="popup-success accord" style="display:none;">
					<p class="f-left"><span></span></p>
					<div class="f-right close-icon comm-icon" onclick="hideStatusDiv(this)"></div>
				</div>
				<div class="popup-error accord" style="display:none;">
					<p class="f-left"><span></span></p>
					<div class="f-right close-icon comm-icon" onclick="hideStatusDiv(this)"></div>
				</div>
			</div>
			
			<div class="popup-header">
				<div id="header">
					<div class="config_header">Create User</div>
				</div>
			</div>
			<div id="content" class="popup-content">
				
				<div class="popup-form-group">
					<label class="popup-control-label">
						Select Domain
					</label>
					<div class="admp-dropdown-container">
						<label> --- Select Domain ---</label>
						<div class="admp-inputgroup-addon" id="domainSelBtn">
							<i class="comm-icon admp-dropicon"></i>
						</div>
						<div class="admp-dropdown-box" id="domainList" style="display: none;"></div>
					</div>
				</div>
			
				<div class="popup-form-group">
					<label class="popup-control-label" >
						Select Template
					</label>
					<div class="admp-dropdown-container">
						<label> --- Select Template --- </label>
						<input type="hidden" id="selectedTemplate" name="template" value="--"/>
						<div class="admp-inputgroup-addon" id="templateSelBtn">
							<i class="comm-icon admp-dropicon"></i>
						</div>
						<div class="admp-dropdown-box" id="templateList" style="display: none;"></div>
					</div>
				</div>
				
				<div class="popup-form-group">
					<label class="popup-control-label">
						First Name
					</label>
					<div class="admp-input-box">
						<input type="text" id="firstName" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="firstNameError">
						<label></label>
					</div>
				</div>
				<div class="popup-form-group">
					<label class="popup-control-label">
						Last Name
					</label>
					<div class="admp-input-box">
						<input type="text" id="lastName" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="lastNameError">
						<label><label>
					</div>
				</div>
				<div class="popup-form-group">
					<label class="popup-control-label">
						Password
					</label>
					<div class="admp-input-box">
						<input type="password" id="password" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="passwordError">
						<label><label>
					</div>
				</div>
				<div class="popup-form-group">
					<label class="popup-control-label">
						Employee ID
					</label>
					<div class="admp-input-box">
						<input type="text" id="empId" class="admp-textinput" placeholder="">
						</div>
					<div class="admp-credentials-error" id="empIdError">
						<label><label>
					</div>
				</div>
						<div class="popup-form-group">
					<label class="popup-control-label">
						Department
					</label>
					<div class="admp-input-box">
						<input type="text" id="department" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="departmentError">
						<label><label>
					</div>
						</div>
				<div class="popup-form-group">
					<label class="popup-control-label">
						Title
					</label>
					<div class="admp-input-box">
						<input type="text" id="title" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="titleError">
						<label><label>
					</div>
				</div>
				<div class="popup-form-group">
					<label class="popup-control-label">
						Mobile Number	
					</label>
					<div class="admp-input-box">
						<input type="text" id="mobileNumber" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="mobileNumberError">
						<label><label>
					</div>
				</div>
				<div class="popup-form-group">
					<label class="popup-control-label">
						Telephone Number
					</label>
					<div class="admp-input-box">
						<input type="text" id="telephoneNumber" class="admp-textinput" placeholder="">
					</div>
					<div class="admp-credentials-error" id="telephoneNumberError">
						<label><label>
					</div>
						</div>
				<div id="overlay" class="popup-overlay"></div>
			</div>
			<div id="footer" class="popup-footer">
				<div class="popup-buttons">
					<input type="button" value="Create" class="btn-green admp-update-button" onClick=createUser()>
					<input type="button" value="Cancel" class="btn-gray admp-update-button" onClick=cancel()>
				</div>
			</div>
			<div class="popup-loading" id="popup_loading"><img class="loading_icon" src="../../images/loading-icon.gif">
			</div>
		</div>
				
		<script>
			$(document).ready(function() {
				$("body").click(function(event){//NO I18N
					var $target = $(event.target);
					if($target.parent().is(".admp-inputgroup-addon") || $target.is(".admp-inputgroup-addon") || $target.parent().is(".admp-dropdown-container") || $target.is(".admp-dropdown-container")){//NO I18N
						var visibility = $target.closest('.admp-dropdown-container').find(".admp-dropdown-box").css('display');
						$(".admp-dropdown-box").hide();
						if(visibility == "none")
							$target.closest('.admp-dropdown-container').find(".admp-dropdown-box").show();
						else
							$target.closest('.admp-dropdown-container').find(".admp-dropdown-box").hide();
					}
					else
						$(".admp-dropdown-box").hide();
				});
			});	
			$('#firstName, #lastName').focus(function(){$("#firstNameError").hide();});
	
			var client = ZAFClient.init();
			var admanagerServerURL = '';
			var admanagerAuthToken = '';
			var admanagerDomainList = '';
			var domainVsTemplateList = '';
			client.metadata().then(function(metadata) {
				admanagerServerURL = metadata.settings.admanagerServerUrl;
				admanagerAuthToken = metadata.settings.admanagerAuthToken;
				admanagerDomainList = metadata.settings.admanagerDomainList;
		
				if(!admanagerServerURL)
				{
					$("#content").animate({scrollTop: 0}, 150);
					$("#content").animate({top: '50px'}, 150, function(){
						$(".popup-error.accord").fadeTo(150, 1);
						$(".popup-error.accord").find("p").empty().append('<span></span> ADManager Plus is not configured. Please contact Zendesk Administrator.');
					});
					$("#content").fadeTo(150, 0.5);
					$("#overlay").show();
					$("#overlay").animate({top: '50px'}, 150);
					$(".btn-green.admp-update-button").prop('disabled', true);
					$(".btn-green.admp-update-button").fadeTo(150, 0.5);
					return;
				}

				showLoadingDiv();
				var getTemplates = {
					url: admanagerServerURL+'/RestAPI/GetAuthInfo?AuthToken='+admanagerAuthToken+'&FILL_RESPONSE_WITH=USER_CREATION_TEMPLATES',
					type: 'POST',
					cors: true,
				};
				client.request(getTemplates).then(function(data) {
					data = ADManagerErrorHandler.handle(data);
					if(data.isSuccess)
					{
						var authObj = data.response.AdmpAuthObject;
						authObj = JSON.parse(authObj);
						domainVsTemplateList = authObj.USER_CREATION_TEMPLATES;
						
						if(admanagerDomainList != null)
						{	
							admanagerDomainList = JSON.parse(admanagerDomainList);
							var html = '<ul>';
							for(var i=0; i<admanagerDomainList.length; i++)
							{
								html += '<li><a onclick="updateDomain(this);">'+admanagerDomainList[i].DOMAIN_NAME+'</a></li>';
							}
							html += '</ul>';
							$("#domainList").html(html);
							var domainName =admanagerDomainList[0].DOMAIN_NAME;
							$("#domainList").closest(".admp-dropdown-container").find("label").text(domainName);
							updateTemplateList(domainName);
						}
					}
					else
					{
						hideStatusDiv();
						var topMargin = getTopMargin(data.response);
						$("#content").animate({top: topMargin}, 150, function(){
							$(".popup-error.accord").fadeTo(150, 1);
							$(".popup-error.accord").find("p").empty().append('<span></span> '+data.response);							
						});
						$("#content").animate({scrollTop: 0}, 150);
					}
					hideLoadingDiv();
				
				}).catch(function(error) {
					hideLoadingDiv();
					hideStatusDiv();
					$("#content").animate({top: '50px'}, 150, function(){						
						$(".popup-error.accord").fadeTo(150, 1);
						$(".popup-error.accord").find("p").empty().append('<span></span> Cannot connect to ADManager Plus. Possible reasons could be no network connection, wrong server name or port number.');
						$("#content").fadeTo(150, 0.5);
					});
					$("#content").animate({scrollTop: 0}, 150);
					
					
					$("#overlay").show();
					$("#overlay").animate({top: '50px'}, 150);
					
					$(".btn-green.admp-update-button").prop('disabled', true);
					$(".btn-green.admp-update-button").fadeTo(150, 0.5);	
				});		
			});
			
			function updateTemplateList(selectedDomain)
			{
				var templateList = domainVsTemplateList[selectedDomain];
				if(templateList != null)
				{
					var templateName = '';
					var html = '<ul>';
					for(var i=0; i<templateList.length;i++)
					{
						html += '<li><a onclick="updateTemplateName(this);">'+templateList[i].TEMPLATE_DISPLAY_NAME+'</a></li>';
						if(templateName == '')
							templateName = templateList[i].TEMPLATE_DISPLAY_NAME;
					}
					html += '</ul>';
					$("#templateList").html(html);
					$("#templateList").closest(".admp-dropdown-container").find("label").text(trimToLength(templateName, 38));
					$("#templateList").closest(".admp-dropdown-container").find("#selectedTemplate").val(templateName);
				}
			}
			
			function updateTemplateName(element)
			{
				$(element).closest(".admp-dropdown-container").find("label").text(trimToLength(element.text, 38));
				$(element).closest(".admp-dropdown-container").find("#selectedTemplate").val(element.text);				
			}
			function updateDomain(element)
			{
				$(element).closest(".admp-dropdown-container").find("label").text(element.text);
				updateTemplateList(element.text);
			}
			function createUser()
			{
				var selectedDomain = $("#domainList").closest(".admp-dropdown-container").find("label").text();
				var selectedTemplate = getSelectedTemplateName();
				var firstName = $("#firstName").val();
				var lastName = $("#lastName").val();
				var password = $("#password").val();
				var mobileNumber = $("#mobileNumber").val();
				var telephoneNumber = $("#telephoneNumber").val();
				var employeeId = $("#empId").val();
				var title = $("#title").val();
				var department = $("#department").val();
				if(!validateInput())
				{
					return;
				}
				
				showLoadingDiv();
				hideStatusDiv();
				var inputDetails = [];
				var userDetail = {};
				userDetail.templateName = selectedTemplate;
				
				if(firstName != '') 
					userDetail.givenName = firstName;
				if(lastName != '') 
					userDetail.sn = lastName;
				if(password != '') 
					userDetail.password = password;
				if(mobileNumber != '') 
					userDetail.mobile = mobileNumber;
				if(telephoneNumber != '') 
					userDetail.telephoneNumber = telephoneNumber;
				if(employeeId != '') 
					userDetail.employeeID = employeeId;
				if(department != '') 
					userDetail.department = department;
				if(title != '') 
					userDetail.title = title;
			
				inputDetails.push(userDetail);
				var createUserPost = {
					url: admanagerServerURL+'/RestAPI/CreateUser?inputFormat='+encodeURIComponent(JSON.stringify(inputDetails))+'&AuthToken='+admanagerAuthToken+'&domainName='+selectedDomain+'&templateCategoryId=5&PRODUCT_NAME=Zendesk&additionalData='+constructAdditionalInput(),
					type: 'POST',
					cors: true,
				};
				client.request(createUserPost).then(function(data) {
					data = ADManagerErrorHandler.handle(data);
					if(data.isSuccess)
					{
						clearAllFields();
						$("#content").animate({top: '50px'}, 150, function(){
							$(".popup-success.accord").fadeTo(150, 1);
							$(".popup-success.accord").find("p").empty().append('<span></span> '+data.response[0].statusMessage+'\n Logon Name : '+data.response[0].LOG_ON_NAME);							
						});
						$("#content").animate({scrollTop: 0}, 150);
					}
					else
					{
						var topMargin = getTopMargin(data.response);
						$("#content").animate({top: topMargin}, 150, function(){
							$(".popup-error.accord").fadeTo(150, 1);
							$(".popup-error.accord").find("p").empty().append('<span></span> '+data.response);						
						});
						$("#content").animate({scrollTop: 0}, 150);
					}
					hideLoadingDiv();
				}).catch(function(error) {
					hideLoadingDiv();
					var topMargin = getTopMargin(data.response);
					$("#content").animate({top: topMargin}, 150, function(){
						$(".popup-error.accord").fadeTo(150, 1);
						$(".popup-error.accord").find("p").empty().append('<span></span> '+data.response);						
					});
					$("#content").animate({scrollTop: 0}, 150);
				});
			}
			function hideStatusDiv()
			{
				$(".popup-error.accord").fadeTo(150, 0);
				$(".popup-success.accord").fadeTo(150, 0);
				$("#content").animate({top: '20px'}); // No I18N
				$("#overlay").animate({top: '20px'}); // No I18N
			}
			function showLoadingDiv()
			{
				$("#popup_loading").show();
				$(".btn-green.admp-update-button").fadeTo(150, 0.5);	
				$(".btn-gray.admp-update-button").fadeTo(150, 0.5);
				$("#content").fadeTo(150, 0.5);
				$("#overlay").show();
				$(".btn-green.admp-update-button").prop('disabled', true);
			}
			function hideLoadingDiv()
			{
				$("#popup_loading").hide();
				$(".btn-green.admp-update-button").fadeTo(150, 1);	
				$(".btn-gray.admp-update-button").fadeTo(150, 1);
				$("#content").fadeTo(150, 1);
				$("#overlay").hide();
				$(".btn-green.admp-update-button").prop('disabled', false);
			}
			function clearAllFields()
			{
				$("#firstName").val('');
				$("#lastName").val('');
				$("#password").val('');
				$("#empId").val('');
				$("#title").val('');
				$("#mobileNumber").val('');
				$("#department").val('');
				$("#telephoneNumber").val('');
			}
			function cancel()
			{
				client.invoke('destroy');
			}
			function getSelectedTemplateName()
			{
				var selectedDomain = $("#domainList").closest(".admp-dropdown-container").find("label").text();
				var selectedTemplate = $("#templateList").closest(".admp-dropdown-container").find("#selectedTemplate").val();
				var templateList = domainVsTemplateList[selectedDomain];
				if(templateList != null)
				{
					for(var i=0; i<templateList.length;i++)
					{
						if(templateList[i].TEMPLATE_DISPLAY_NAME == selectedTemplate)
							return templateList[i].TEMPLATE_NAME;
					}
				}
				return selectedTemplate;
			}
			function trimToLength(string, limit){
			  return (string.length > limit) ? (string.substring(0, limit-3) + '...' ) : string;
			}
			function getTopMargin(string)
			{
				if(string.length < 125)
					return '50px';
				if(string.length < 250)
					return '63px';
				else
					return '75px';
			}
			function validateInput()
			{
				var firstName = $("#firstName").val();
				var lastName = $("#lastName").val();
				var isValid = true;
				if(firstName == '' && lastName == '')
				{
					$("#firstNameError").find('label').text('Username cannot be empty!');
					isValid = false;
				}
				else if(firstName.length >250)
				{
					$("#firstNameError").find('label').text('Username field exceeds the maximum length!');
					isValid = false;
				}
				else if(lastName.length >250)
				{
					$("#firstNameError").find('label').text('Username field exceeds the maximum length!');
					isValid = false;
				}
				else if((firstName + lastName).length >200)
				{
					$("#firstNameError").find('label').text('Username field exceeds the maximum length!');
					isValid = false;
				}
				
				if(!isValid)
				{
					var firstNameError = $('#firstNameError').offset().top;
					$("#firstNameError").show();
					$("#content").animate({scrollTop: firstNameError}, 150);
				}
				return isValid;
			}
			function constructAdditionalInput()
			{
				var ticket_id = ADManagerCommonUtil.getParamValuesByName('ticket_id');
				var addtionalData = {};
				addtionalData.reqId = ticket_id;
				return JSON.stringify(addtionalData);
			}
		</script>
	</body>
</html>
